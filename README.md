# Artificien: Infrastructure
This repo stores infrastructure and deployment code for the Artificien platform as a single source for deployment. Infrastructure includes a DynamoDB (NoSQL database) utilized by the Marketplace, the severless backend, mechanisms to distribute and train models remotely, and any other cloud resources which may be relevant to the product.

## Architecture
- `Amplify`: Handles the deployment of the front end of the Artificien Website. Deploys a new copy every time a new commit is pushed to the master branch of our artificien_marketplace repository (continuous deploys). Amplify automatically integrates the frontend with its associated backed resources.
- `Cognito`: Handles authentication to both the website and the Artificien site. Provides an email-based confirmation service for new signups, and other authentication features.
- `Data Upload Lambda`: This serverless function is triggered whenever an app developer uploads a new dataset to artificien.com. Based on the data schema entered by the developer on artificien.com, this script generates a sample dataset, and populates an S3 bucket with the new sample data csv. Customers can then use sample data to test their models before deploying them to client devices.
- `Model Retrieval Lambda`: This serverless function is deployed as a REST API via AWS API Gateway. When the '/retrieve' endpoint is hit with a model name and version, this endpoint retrieves the given specified model from PyGrid, uploads it to S3 storage, and allows the user to download the model as a Python PKL file. This function is invoked via the front end 'models' page, and allows users to download their newly trained models after devices have finished training their models.
- `Jupyter`: Deploys a multi-user JupyterHub server, gated by Cognito, which can be used by Artificien customers to train and deploy models.
- `Dynamo DB`: Stores data for the website and user data generated by Cognito.
- `PyGrid`: Deploys a [PyGrid Node](https://github.com/OpenMined/PyGrid), a REST service which acts as the orchestration node for federated learning jobs. iPhones, Androids, and Web Browsers contact the node to download new FL jobs.

## Setup
- Install aws cli: ` python -m pip install awscli`
- Configure aws credentials for your terminal: `aws configure`, and paste in the access Access Key ID and Secret Access Key for our AWS account.
- Install aws cdk: `npm i -g aws-cdk`

## Deployment

- Enter top-level directory
- Install python libraries: `pip install -r requirements.txt`
- If you want to deploy all resources, or need to deploy one of the lambda functions, you may need to run `cdk bootstrap` first. Uploading code artifacts to AWS, a key step in deploying any lambda function, requires this command to have been run recently before a deployment.
- To deploy all resources
  - `cdk synth` - to create cloudformation templates
  - `cdk diff` - to see what changes will be made to our deployments
  - `cdk deploy` - to deploy new changes to **all** resources
- To deploy just one resource:
  - `cdk deploy dynamo-db` or `cdk deploy amplify` or `cdk deploy jupyter` or `cdk deploy cognito` or `cdk deploy pygrid` or `cdk deploy dataUploadLambda`. Check the `app.py` file to find names of other stacks that we may add as we develop.
- Post Deploy: There are some actions that must be performed **after** cdk has finished deploying, either because the action involves a non-AWS resource, or because the action is not related to deployment itself but rather to the population of data or configuration of the resource once deployment is complete.
  - Run post deploy actions after `cdk deploy` with `python post_deploy_actions.py`
- Test (tests are not complete)
  - `pytest tests/unit` to run the unit tests (pre-deployment)
  - `pytest tests/integration` to populate the sample DynamoDB table with data and test that it's queryable (run this AFTER `cdk deploy`)
  
## Usage
- See all aws resources that have been created by viewing the `app.py` file.
- Add new python package requirements by adding them to the `requirements.txt`

## Authors
* Alex Quill (DynamoDB, Lambda code and Lambda-related resources)
* Matt Kenney (Amplify, Lambdas, Cognito, PyGrid, and Lambda code)
* Jake Epstein (JupyterHub and Cognito integrations with JupyterHub)
* Tobias Lange (Contributed lambda function code)

## Acknowledgments
* AWS: Thank you AWS for your limitless resources and yet terrible documentation.
* OpenMined: Creators of PyGrid and authored PyGrid Dockerfile used to deploy the REST service which orchestrates our Federated Learning jobs.